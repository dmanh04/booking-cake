<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::main}, 'S·∫£n Ph·∫©m - Bakery', ~{::extraHead}, ~{::extraScripts})}">

<head>
    <title>S·∫£n Ph·∫©m - Bakery</title>

    <th:block th:fragment="extraHead">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cupcake Trung Thu - Chi Ti·∫øt S·∫£n Ph·∫©m</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" th:href="@{/css/login.css}">
        <style>
            .product-actions {
                display: flex;
                gap: 10px;
            }

            .view-details {
                background: transparent;
                border: 2px solid #8B4513;
                color: #8B4513;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s;
                flex: 1;
            }

            .view-details:hover {
                background: #8B4513;
                color: white;
            }

            .view-details:disabled {
                background: #ccc;
                border-color: #ccc;
                color: #666;
                cursor: not-allowed;
            }

            .add-to-cart {
                flex: 1;
            }

            .add-to-cart:disabled {
                background: #ccc;
                color: #666;
                cursor: not-allowed;
            }

            @media (max-width: 768px) {
                .products-grid {
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                }

                .product-actions {
                    flex-direction: column;
                }
            }

            .product-variants {
                margin-top: 10px;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn-variant {
                display: inline-block;
                padding: 8px 12px;
                background: #f8f8f8;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
                color: #333;
                text-decoration: none;
                transition: all 0.2s ease;
            }

            .btn-variant:hover {
                background: #ffe6e6;
                border-color: #ff9999;
                color: #c00;
            }

            .btn-variant.active {
                background: #8B4513;
                color: white;
                border-color: #8B4513;
                font-weight: bold;
            }

            .variant {
                display: inline-block;
                background: #f0f0f0;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 12px;
                margin: 2px;
                color: #8B4513;
                font-weight: bold;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            }

            .product-thumbnail {
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .product-thumbnail:hover {
                transform: scale(1.05);
            }

            .product-thumbnail.active {
                border-color: #78350f;
            }

            .tab-button {
                transition: all 0.3s ease;
            }

            .tab-button.active {
                background-color: #78350f;
                color: white;
            }

            /* <CHANGE> th√™m style cho stock info */
            .stock-info {
                font-size: 14px;
                color: #666;
                margin-top: 5px;
                font-weight: 500;
            }

            .stock-info.low-stock {
                color: #d97706;
            }

            .warning-message {
                background-color: #fee2e2;
                border: 1px solid #fca5a5;
                color: #dc2626;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 16px;
                display: none;
                font-weight: 500;
            }

            .warning-message.show {
                display: block;
            }
        </style>
    </th:block>
</head>

<body>
<th:block th:fragment="main">

    <div th:if="${errorMessage}" th:utext="${errorMessage}" id="errorMessage" style="display:none"></div>
    <script th:if="${errorMessage}">
        alert(document.getElementById('errorMessage').innerText);
    </script>



    <!-- N·ªôi dung trang ch√≠nh -->
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Product Detail Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
            <!-- Product Images -->
            <div class="space-y-4">
                <!-- Main Image -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <img
                            id="mainImage"
                            th:src="${productDetail.variants[0].product.imgUrl}"
                            alt="Cupcake Trung Thu"
                            class="w-full h-auto rounded-lg"
                            style="max-height: 450px"
                    />
                </div>

            </div>

            <!-- Product Info -->
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-4 uppercase" th:text="${productDetail.name}"></h1>

                <!-- Price -->
                <p class="mb-3 text-lg">
                    Gi√°:
                    <span id="displayPrice" class="font-bold text-amber-900">
        0‚Ç´
    </span>
                </p>
                <div class="product-variants">
                    <div th:each="variant : ${productDetail.variants}">
                        <button type="button"
                                class="btn-variant"
                                th:text="${variant.weight} + 'gram'"
                                th:data-variant-id="${variant.variantId}"
                                th:data-price="${variant.price}"
                                th:data-stock="${variant.stock}"
                                onclick="selectVariant(this)">
                        </button>
                    </div>
                </div>
                <!-- <CHANGE> hi·ªÉn th·ªã stock c·ªßa variant ƒë∆∞·ª£c ch·ªçn -->
                <div class="stock-info" id="stockInfo" style="display: none;">
                    C√≥ s·∫µn: <span id="stockAmount">0</span> s·∫£n ph·∫©m
                </div>

                <!-- <CHANGE> th√™m warning message khi v∆∞·ª£t qu√° stock -->
                <div class="warning-message" id="warningMessage">
                    ‚ö†Ô∏è S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng c√≥ s·∫µn. Vui l√≤ng gi·∫£m s·ªë l∆∞·ª£ng.
                </div>

                <!-- Quantity Selector -->
                <div class="mb-6">
                    <label class="text-gray-700 font-medium mb-2 block">S·ªë l∆∞·ª£ng:</label>
                    <div class="flex items-center gap-3">
                        <button type="button" onclick="decreaseQuantity()" class="w-10 h-10 flex items-center justify-center border-2 border-gray-300 rounded hover:bg-gray-100 transition">
                            <span class="text-xl">‚àí</span>
                        </button>
                        <input type="number" id="quantity" value="1" min="1" class="w-16 h-10 text-center border-2 border-gray-300 rounded focus:outline-none focus:border-amber-900"/>
                        <button type="button" onclick="increaseQuantity()" class="w-10 h-10 flex items-center justify-center border-2 border-gray-300 rounded hover:bg-gray-100 transition">
                            <span class="text-xl">+</span>
                        </button>
                    </div>
                </div>

                <div class="product-actions">
                    <form id="buyNowForm" th:action="@{/products/buy-now}" method="post" style="flex: 1;">
                        <input type="hidden" name="variantId" id="buyNowVariantId" />
                        <input type="hidden" name="quantity" id="buyNowQuantity" value="1"/>
                        <button type="submit" id="buyNowBtn" class="view-details" style="width: 100%;">MUA NGAY</button>
                    </form>
                    <form id="addToCartForm" th:action="@{'/products/' + ${productDetail.productId} + '/add'}" method="get">
                        <input type="hidden" name="variantId" id="selectedVariantId" />
                        <input type="hidden" name="quantity" id="selectedQuantity" value="1"/>
                        <button type="submit" id="addToCartBtn" class="add-to-cart">TH√äM V√ÄO GI·ªé</button>
                    </form>
                </div>

                <!-- Stock Status -->
                <!--                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">-->
                <!--                    <p class="text-red-600 font-medium">T·∫°m h·∫øt h√†ng</p>-->
                <!--                </div>-->
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="bg-white rounded-lg shadow-lg mb-16">
            <div class="flex border-b">
                <button
                        class="tab-button active px-8 py-4 font-bold text-sm uppercase tracking-wide"
                        onclick="switchTab('description')"
                        id="descTab"
                >
                    M√¥ t·∫£ chung
                </button>
                <button
                        class="tab-button px-8 py-4 font-medium text-sm uppercase tracking-wide bg-gray-100 text-gray-700"
                        onclick="switchTab('comments')"
                        id="commentsTab"
                >
                    B√¨nh lu·∫≠n
                </button>
            </div>

            <div class="p-8">
                <div id="descriptionContent" class="tab-content">
                    <p class="text-gray-600" th:utext="${productDetail.description}"></p>
                </div>
                <div id="commentsContent" class="tab-content hidden">
                    <p class="text-gray-600">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</p>
                </div>
            </div>
        </div>

        <!-- Related Products Section -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold mb-2" style="color: #a3b18a;">C√ì TH·ªÇ B·∫†N TH√çCH</h2>
            <p class="text-gray-700 font-medium uppercase tracking-wide">S·∫£n ph·∫©m c√πng lo·∫°i</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div th:each="product : ${products}" class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition">
                <div class="p-4">
                    <img th:src="${product.imgUrl}"
                         class="w-full h-64 object-cover rounded-lg mb-4"/>
                </div>
                <div class="px-4 pb-4">
                    <h3 class="text-center font-bold text-gray-800 mb-2 uppercase text-sm" th:text="${product.name}"></h3>
                    <p class="text-center text-gray-500 text-xs mb-3" th:text="${product.shortDescription}"></p>
                    <div class="flex gap-2">
                        <!--                        <button class="flex-1 bg-[#a3b18a] text-white py-2 px-4 rounded font-bold text-sm hover:bg-[#8a9a75] transition"-->
                        <!--                                th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + '‚Ç´'">-->
                        <!--                        </button>-->
                        <button class="w-10 h-10 bg-[#78350f] text-white rounded flex items-center justify-center hover:bg-[#5a2709] transition">
                            üõí
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</th:block>

<th:block th:fragment="extraScripts">
    <script>
        let selectedVariantId = null;
        let selectedPrice = 0;
        let selectedStock = 0;

        function formatPrice(price) {
            return price.toLocaleString('vi-VN') + '‚Ç´';
        }

        function selectVariant(button) {
            // <CHANGE> L·∫•y variantId, gi√° v√† stock t·ª´ thu·ªôc t√≠nh data
            selectedVariantId = button.getAttribute('data-variant-id');
            selectedPrice = parseFloat(button.getAttribute('data-price'));
            selectedStock = parseInt(button.getAttribute('data-stock'));

            // B·ªè active c≈©, th√™m active m·ªõi
            document.querySelectorAll('.btn-variant').forEach(b => b.classList.remove('active'));
            button.classList.add('active');

            // <CHANGE> hi·ªÉn th·ªã stock info
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('stockAmount').innerText = selectedStock;

            // Reset quantity v·ªÅ 1 khi ch·ªçn variant m·ªõi
            document.getElementById('quantity').value = 1;
            updateQuantityInput(1);
            // updateDisplayedPrice();
            checkStockValidity();
        }

        // <CHANGE> h√†m ki·ªÉm tra xem s·ªë l∆∞·ª£ng c√≥ v∆∞·ª£t qu√° stock hay kh√¥ng
        function checkStockValidity() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const warningMsg = document.getElementById('warningMessage');
            const addToCartBtn = document.getElementById('addToCartBtn');
            const buyNowBtn = document.getElementById('buyNowBtn');

            if (quantity > selectedStock) {
                // V∆∞·ª£t qu√° stock - disable buttons v√† hi·ªÉn th·ªã warning
                warningMsg.classList.add('show');
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
            } else {
                // H·ª£p l·ªá - enable buttons v√† ·∫©n warning
                warningMsg.classList.remove('show');
                addToCartBtn.disabled = false;
                buyNowBtn.disabled = false;
            }
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity');
            const newValue = parseInt(input.value) + 1;

            // <CHANGE> ki·ªÉm tra tr∆∞·ªõc khi tƒÉng
            if (newValue > selectedStock) {
                // Kh√¥ng cho tƒÉng v∆∞·ª£t qu√° stock
                document.getElementById('warningMessage').classList.add('show');
                return;
            }

            input.value = newValue;
            updateQuantityInput(input.value);
            checkStockValidity();
            // updateDisplayedPrice();
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
                updateQuantityInput(input.value);
                checkStockValidity();
                // updateDisplayedPrice();
            }
        }

        function updateQuantityInput(value) {
            document.getElementById('selectedQuantity').value = value;
            document.getElementById('buyNowQuantity').value = value;
        }

        function updateDisplayedPrice() {
            const qty = parseInt(document.getElementById('quantity').value);
            const total = selectedPrice * qty;
            document.getElementById('displayPrice').innerText = formatPrice(total);
        }

        // Khi submit form th√™m v√†o gi·ªè h√†ng
        document.getElementById('addToCartForm').addEventListener('submit', function(e) {
            if (!selectedVariantId) {
                e.preventDefault();
                alert("Vui l√≤ng ch·ªçn 1 bi·∫øn th·ªÉ tr∆∞·ªõc khi th√™m v√†o gi·ªè h√†ng.");
                return;
            }
            document.getElementById('selectedVariantId').value = selectedVariantId;

            const productId = /*[[${productDetail.productId}]]*/ '1';
            this.action = `/products/${productId}/add/${selectedVariantId}`;
        });

        // Khi submit form mua ngay
        document.getElementById('buyNowForm').addEventListener('submit', function(e) {
            if (!selectedVariantId) {
                e.preventDefault();
                alert("Vui l√≤ng ch·ªçn 1 bi·∫øn th·ªÉ tr∆∞·ªõc khi mua.");
                return;
            }
            document.getElementById('buyNowVariantId').value = selectedVariantId;
        });

        const qtyInput = document.getElementById('quantity');

        qtyInput.addEventListener('input', function () {
            let value = parseInt(qtyInput.value);

            // N·∫øu nh·∫≠p k√Ω t·ª± kh√¥ng ph·∫£i s·ªë ‚Üí chuy·ªÉn v·ªÅ 1
            if (isNaN(value) || value < 1) {
                value = 1;
            }

            // Kh√¥ng cho v∆∞·ª£t qu√° stock
            if (selectedStock && value > selectedStock) {
                value = selectedStock;
            }

            qtyInput.value = value;

            updateQuantityInput(value);
            checkStockValidity();
            updateDisplayedPrice();
        });

        qtyInput.addEventListener('blur', function () {
            if (qtyInput.value === "" || qtyInput.value === "0") {
                qtyInput.value = 1;
                updateQuantityInput(1);
            }
        });
    </script>


</th:block>
</body>
</html>